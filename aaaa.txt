Reviewing the implementation against the requirements and making adjustments:


[14 tools called]


Fixing variable references:


[3 tools called]


## Implementation complete

### Files created/modified

**1. Created: `scripts/postdeploy-verify.sh` (184 lines)**
- Bash strict mode: `set -euo pipefail`
- Uses exact compose project + files: `PROJECT="eshop"`, `FILES=(-f docker-compose.production.yml -f docker-compose.override.yml -f docker-compose.nginx-override.yml)`
- Verifies critical services: `api-gateway`, `auth-service`
- For each service:
  - a) Container exists check: `CID=$(docker compose -p "$PROJECT" "${FILES[@]}" ps -q "$svc")`
  - b) Container status check: `docker inspect -f '{{.State.Status}}' "$CID"` (must be "running")
  - c) Healthcheck status: `docker inspect -f '{{if .State.Health}}{{.State.Health.Status}}{{end}}' "$CID"` (must be "healthy" if healthcheck exists)
  - HTTP checks: localhost endpoints (gateway:8080/gateway-health, auth-service:6001 tries /api, /health, /)
- On failure: prints last 120 lines of service logs and exits 1

**2. Modified: `scripts/deploy-production.sh`**
- Added Step 6 at the end (lines 195-211):
  - Runs `./scripts/postdeploy-verify.sh` if it exists
  - Falls back to `/usr/local/bin/eshop-postdeploy-check.sh` if repo script missing
  - Ensures script is executable before running

**3. Modified: `.github/workflows/docker-build.yml`**
- Removed redundant call to `/usr/local/bin/eshop-postdeploy-check.sh` (now handled by deploy script)

---

### Evidence

**Syntax validation:**
```bash
bash -n scripts/postdeploy-verify.sh   # ‚úÖ Valid
bash -n scripts/deploy-production.sh   # ‚úÖ Valid
```

**Key implementation details:**
- Uses exact variable names: `PROJECT="eshop"`, `FILES=(-f ...)`
- Container ID check: `docker compose -p "$PROJECT" "${FILES[@]}" ps -q "$svc"`
- Healthcheck check: `{{if .State.Health}}{{.State.Health.Status}}{{end}}` (handles missing healthcheck)
- HTTP checks: localhost only (no external calls)
- Logs on failure: `--tail=120` as specified
- Exit codes: 0 on success, 1 on failure (causes GitHub Actions to fail)

---

### Diffs

**`scripts/postdeploy-verify.sh` (new file)**
```bash
#!/bin/bash
set -euo pipefail

PROJECT="eshop"
FILES=(-f docker-compose.production.yml -f docker-compose.override.yml -f docker-compose.nginx-override.yml)

CRITICAL_SERVICES=("api-gateway" "auth-service")

# [Full implementation with container checks, health checks, HTTP checks]
```

**`scripts/deploy-production.sh` (added at end)**
```bash
# --------------------------------------------------------------------
# 6) Post-deploy verification (fail-fast on critical service failures)
# --------------------------------------------------------------------
echo ""
echo "üîç Running post-deploy verification..."

if [ -f "./scripts/postdeploy-verify.sh" ]; then
  chmod +x ./scripts/postdeploy-verify.sh
  ./scripts/postdeploy-verify.sh nomadnet.shop
elif [ -f "/usr/local/bin/eshop-postdeploy-check.sh" ]; then
  bash /usr/local/bin/eshop-postdeploy-check.sh nomadnet.shop
else
  echo "‚ö†Ô∏è  Post-deploy verification script not found"
  echo "   Skipping detailed verification..."
fi
```

**`.github/workflows/docker-build.yml` (removed redundant call)**
```yaml
# Before:
./scripts/deploy-production.sh
bash /usr/local/bin/eshop-postdeploy-check.sh nomadnet.shop

# After:
./scripts/deploy-production.sh
# Note: deploy-production.sh now includes post-deploy verification
```

---

### How it prevents "green but broken" deploys

1. Container existence: fails if container doesn't exist (e.g., failed to start)
2. Running status: fails if container is "exited", "restarting", etc.
3. Health status: fails if healthcheck exists and status is not "healthy" (catches runtime crashes)
4. HTTP endpoints: fails if services don't respond (catches app-level failures)

On any failure:
- Prints last 120 lines of service logs
- Exits with code 1
- GitHub Actions step fails (appleboy/ssh-action fails on non-zero exit)
- CI/CD shows red, preventing false positives

---

**Status:** CI/CD now fails fast if critical services (especially auth-service) are not running/healthy after deployment. The script verifies containers, health status, and HTTP endpoints, preventing "green but broken" deploys.