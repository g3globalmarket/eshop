Locating the docker-compose file that defines the nginx service and adding the volume mount for `nginx.conf`:


[4 tools called]


The override file mounts the wrong path. Updating it to mount the repo's `nginx.conf`:


[3 tools called]


Verifying the order and checking the compose file structure:


[5 tools called]


## Summary

**Status:** Nginx now uses the repo's `nginx.conf` persistently, and `/payments/*` routing is configured.

### Changes Made

**File:** `docker-compose.nginx-override.yml`

**Diff:**
```diff
services:
  nginx:
    volumes:
-     - ./ops-backups/nginx.conf:/etc/nginx/nginx.conf:ro
+     - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - /var/lib/letsencrypt:/var/lib/letsencrypt:ro
      - /var/www/certbot:/var/www/certbot
```

**Change:** Mount path updated from `./ops-backups/nginx.conf` to `./nginx.conf` to use the repo's config file.

### Verification Results

**1. Nginx config mount:**
- `docker-compose.nginx-override.yml` mounts `./nginx.conf:/etc/nginx/nginx.conf:ro` (read-only)

**2. `/payments/` routing in nginx.conf:**
- All 3 server blocks have `location ^~ /payments/`:
  - `nomadnet.shop`: line 72 (before `location / {` at line 80)
  - `sellers.nomadnet.shop`: line 123 (before `location / {` at line 128)
  - `admin.nomadnet.shop`: line 170 (before `location / {` at line 174)

**3. Location priority:**
- `^~` modifier ensures `/payments/` takes precedence over regex locations
- Placement before `location / {` ensures it's matched first

### Post-Deployment Verification Commands

Run these on the production server after deployment:

```bash
# 1) Test Nginx config syntax
NGX=$(docker compose -p eshop -f docker-compose.production.yml -f docker-compose.override.yml -f docker-compose.nginx-override.yml ps -q nginx)
docker exec "$NGX" nginx -t

# Expected output: "nginx: configuration file /etc/nginx/nginx.conf test is successful"

# 2) Restart nginx container to load new config
docker compose -p eshop -f docker-compose.production.yml -f docker-compose.override.yml -f docker-compose.nginx-override.yml restart nginx

# OR if using docker compose up:
# docker compose -p eshop -f docker-compose.production.yml -f docker-compose.override.yml -f docker-compose.nginx-override.yml up -d nginx

# 3) Verify endpoint is NOT hitting Next.js frontend
curl -I "https://nomadnet.shop/payments/qpay/status?sessionId=test"

# Expected: Should NOT have `x-powered-by: Next.js` header
# Expected: Should return 400/401 (invalid session) from backend, NOT 404 from Next.js
# Expected headers: `server: nginx` (not Next.js)
```

### Expected Behavior After Deployment

1. Nginx container loads `/etc/nginx/nginx.conf` from the mounted repo file
2. All `/payments/*` requests are proxied to `api_backend` (API Gateway)
3. Next.js frontend does not receive `/payments/*` requests
4. QPay endpoints (`/payments/qpay/seed-session`, `/payments/qpay/status`, etc.) work correctly

### Files Changed

1. `docker-compose.nginx-override.yml`: Fixed volume mount path
2. `nginx.conf`: Already has correct `/payments/` routing (from previous fix)

All changes are complete and ready for deployment.