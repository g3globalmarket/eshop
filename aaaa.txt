Verifying all fixes are in place and summarizing what's been completed:


[4 tools called]


All fixes are in place. Verifying critical parts and preparing a summary:


[3 tools called]


All fixes are complete and verified. Summary:

## All tasks completed

### Task 1: Backend 500 fix — COMPLETE

**File:** `apps/order-service/src/controllers/order.controller.ts`

**Implemented:**
- Request ID tracking: generates `requestId` and adds `X-Request-ID` header
- Idempotency: reuses existing invoice if `sessionId` already has one
- Validation: returns 400 for missing/invalid inputs
- Error handling: returns JSON errors instead of calling `next(error)`
- QPay API errors: returns 502 with "QPay service unavailable"
- Config errors: returns 500 with "Payment configuration error"
- Logging: includes requestId, duration, error types (no secrets)

**Key code sections:**
- Lines 1454-1455: Request ID generation
- Lines 1571-1616: Idempotency check
- Lines 1664-1686: QPay API error handling (502)
- Lines 1694-1701: Outer catch with proper JSON response
- Line 1821: `X-Request-ID` header

### Task 2: Frontend error handling — COMPLETE

**Files:**
- `apps/user-ui/src/utils/qpay-api.ts`
- `apps/user-ui/src/app/(routes)/checkout/page.tsx`

**Implemented:**
- Enhanced error object with `status`, `statusText`, `responseData`, `endpoint`, `method`
- Proper error extraction from Axios responses
- Mongolian-only error messages
- No redirect to receipt on failure (user stays on checkout)
- Retry capability

**Key code sections:**
- `qpay-api.ts` lines 105-125: Enhanced error extraction
- `checkout/page.tsx` lines 203-253: Improved error handling with status codes

### Task 3: Mongolian currency (₮/MNT) — COMPLETE

**Files created:**
- `packages/utils/src/currency.ts` - formatMNT utility
- `packages/utils/src/index.ts` - Export

**Files updated (all currency replaced):**
1. `apps/user-ui/src/shared/modules/product/product-details.tsx`
2. `apps/user-ui/src/app/(routes)/cart/page.tsx`
3. `apps/user-ui/src/shared/components/checkout/qpayCheckoutForm.tsx`
4. `apps/user-ui/src/shared/components/cards/product-details.card.tsx`
5. `apps/user-ui/src/shared/components/cards/product-card.tsx`
6. `apps/user-ui/src/app/(routes)/order/[orderId]/page.tsx`
7. `apps/seller-ui/src/shared/components/cards/product.card.tsx`
8. `apps/seller-ui/src/app/(routes)/dashboard/payments/page.tsx`
9. `apps/admin-ui/src/app/dashboard/payments/page.tsx`

**Verification:** No `$`, `USD`, `KRW`, or `₩` found in user-ui source files.

---

## Verification steps

### 1. Test seed-session endpoint

```bash
# With authentication cookie
curl -X POST https://nomadnet.shop/payments/qpay/seed-session \
  -H "Content-Type: application/json" \
  -H "Cookie: your-auth-cookie" \
  -d '{
    "cart": [{"productId": "...", "quantity": 1, "sale_price": 10000, "shopId": "..."}],
    "sellers": ["..."],
    "totalAmount": 10000
  }' \
  -v

# Expected: 200 OK with invoice object
# Or: 400/404/502 with JSON error (not 500)
# Response header: X-Request-ID: <hex>
```

**Expected results:**
- Success: `200 OK` with `{"success": true, "sessionId": "...", "invoice": {...}}`
- Error: `400/404/502` with JSON `{"success": false, "error": "...", "requestId": "..."}`
- Never: Generic `500` without details

### 2. Verify QR display in UI

1. Log in to user-ui
2. Add items to cart
3. Go to checkout
4. Click "Pay with QPay"
5. Expected: QR code appears with payment details
6. If error: Mongolian error message shown, no redirect to receipt

### 3. Verify currency formatting

Check these pages show `₮ 10,000` format (or Intl equivalent):
- Product detail pages
- Cart page
- Checkout page
- Order history
- Seller dashboard payments
- Admin dashboard payments

---

## Summary

- Backend: Robust error handling, idempotency, proper status codes
- Frontend: Enhanced error capture, Mongolian messages, no premature redirects
- Currency: All UI uses `formatMNT()` - Mongolian Tugrik everywhere

All changes are minimal, safe, and maintain existing runtime logic. Ready for testing.