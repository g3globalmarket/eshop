name: Build & Deploy

on:
  push:
    branches: [master, develop, main]
    paths-ignore:
      - "**/*.md"
      - "docs/**"
      - ".vscode/**"
      - ".devcontainer/**"
      - ".github/ISSUE_TEMPLATE/**"
  pull_request:
    branches: [master, main]
    paths-ignore:
      - "**/*.md"
      - "docs/**"
      - ".vscode/**"
      - ".devcontainer/**"
      - ".github/ISSUE_TEMPLATE/**"
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: "Force rebuild all services"
        required: false
        default: "false"

env:
  DOCKER_REGISTRY: docker.io
  DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKERHUB_TOKEN }}

concurrency:
  group: deploy-production
  cancel-in-progress: false
jobs:
  # Detect which services have changed
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend-matrix: ${{ steps.set-matrix.outputs.backend-matrix }}
      frontend-matrix: ${{ steps.set-matrix.outputs.frontend-matrix }}
      has-backend-changes: ${{ steps.set-matrix.outputs.has-backend-changes }}
      has-frontend-changes: ${{ steps.set-matrix.outputs.has-frontend-changes }}
      changed-backend: ${{ steps.set-matrix.outputs.changed-backend }}
      changed-frontend: ${{ steps.set-matrix.outputs.changed-frontend }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files_yaml: |
            auth_service:
              - apps/auth-service/**
              - packages/libs/redis/**
              - packages/libs/prisma/**
              - packages/middleware/**
              - packages/error-handler/**
              - packages/utils/logs/**
            product_service:
              - apps/product-service/**
              - packages/libs/imagekit/**
              - packages/libs/prisma/**
              - packages/middleware/**
              - packages/error-handler/**
            order_service:
              - apps/order-service/**
              - packages/libs/prisma/**
              - packages/middleware/**
              - packages/error-handler/**
              - packages/utils/logs/**
            seller_service:
              - apps/seller-service/**
              - packages/libs/prisma/**
              - packages/middleware/**
              - packages/error-handler/**
            admin_service:
              - apps/admin-service/**
              - packages/libs/prisma/**
              - packages/middleware/**
              - packages/error-handler/**
            chatting_service:
              - apps/chatting-service/**
              - packages/libs/redis/**
              - packages/middleware/**
              - packages/error-handler/**
            kafka_service:
              - apps/kafka-service/**
              - packages/utils/kafka/**
              - packages/middleware/**
              - packages/error-handler/**
            logger_service:
              - apps/logger-service/**
              - packages/utils/logs/**
              - packages/utils/kafka/**
              - packages/middleware/**
              - packages/error-handler/**
            recommendation_service:
              - apps/recommendation-service/**
              - packages/middleware/**
              - packages/error-handler/**
            api_gateway:
              - apps/api-gateway/**
              - packages/libs/redis/**
              - packages/libs/prisma/**
              - packages/middleware/**
              - packages/error-handler/**
              - packages/utils/logs/**
            user_ui:
              - apps/user-ui/**
              - packages/components/**
              - packages/utils/**
              - packages/libs/**
            seller_ui:
              - apps/seller-ui/**
              - packages/components/**
              - packages/utils/**
              - packages/libs/**
            admin_ui:
              - apps/admin-ui/**
              - packages/components/**
              - packages/utils/**
              - packages/libs/**

      - name: Set deployment matrix
        id: set-matrix
        run: |
          # Backend services mapping
          declare -A backend_services=(
            ["auth_service"]="auth-service"
            ["product_service"]="product-service"
            ["order_service"]="order-service"
            ["seller_service"]="seller-service"
            ["admin_service"]="admin-service"
            ["chatting_service"]="chatting-service"
            ["kafka_service"]="kafka-service"
            ["logger_service"]="logger-service"
            ["recommendation_service"]="recommendation-service"
            ["api_gateway"]="api-gateway"
          )

          # Frontend apps mapping
          declare -A frontend_apps=(
            ["user_ui"]="user-ui"
            ["seller_ui"]="seller-ui"
            ["admin_ui"]="admin-ui"
          )

          # Initialize arrays
          backend_changed=()
          frontend_changed=()

          # Check which backend services changed
          for key in "${!backend_services[@]}"; do
            if [[ "${{ steps.changed-files.outputs.${key}_any_changed }}" == "true" ]]; then
              backend_changed+=("${backend_services[$key]}")
            fi
          done

          # Check which frontend apps changed
          for key in "${!frontend_apps[@]}"; do
            if [[ "${{ steps.changed-files.outputs.${key}_any_changed }}" == "true" ]]; then
              frontend_changed+=("${frontend_apps[$key]}")
            fi
          done

          # Create JSON matrices
          backend_json=$(printf '%s\n' "${backend_changed[@]}" | jq -R . | jq -s .)
          frontend_json=$(printf '%s\n' "${frontend_changed[@]}" | jq -R . | jq -s .)

          # If workflow_dispatch with force_rebuild, rebuild all
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.force_rebuild }}" == "true" ]]; then
            backend_json='["auth-service","product-service","order-service","seller-service","admin-service","chatting-service","kafka-service","logger-service","recommendation-service","api-gateway"]'
            frontend_json='["user-ui","seller-ui","admin-ui"]'
          fi

          # Set outputs
          echo "backend-matrix=${backend_json}" >> $GITHUB_OUTPUT
          echo "frontend-matrix=${frontend_json}" >> $GITHUB_OUTPUT
          echo "has-backend-changes=$([[ ${#backend_changed[@]} -gt 0 ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "has-frontend-changes=$([[ ${#frontend_changed[@]} -gt 0 ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "changed-backend=${backend_json}" >> $GITHUB_OUTPUT
          echo "changed-frontend=${frontend_json}" >> $GITHUB_OUTPUT

  # Build backend services
  build-backend:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.has-backend-changes == 'true'
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.backend-matrix) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: Build and push backend service
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/${{ matrix.service }}/Dockerfile.production
          push: true
          tags: |
            ${{ env.DOCKER_USERNAME }}/${{ matrix.service }}:latest
            ${{ env.DOCKER_USERNAME }}/${{ matrix.service }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Build frontend apps
  build-frontend:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.has-frontend-changes == 'true'
    strategy:
      fail-fast: false
      matrix:
        app: ${{ fromJson(needs.detect-changes.outputs.frontend-matrix) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: Build and push frontend app
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/${{ matrix.app }}/Dockerfile.production
          push: true
          tags: |
            ${{ env.DOCKER_USERNAME }}/${{ matrix.app }}:latest
            ${{ env.DOCKER_USERNAME }}/${{ matrix.app }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Deploy to EC2
  deploy-to-ec2:
    needs: [detect-changes, build-backend, build-frontend]
    runs-on: ubuntu-latest
    if: always() && (needs.build-backend.result == 'success' || needs.build-backend.result == 'skipped') && (needs.build-frontend.result == 'success' || needs.build-frontend.result == 'skipped')

    steps:
      - name: Check EC2 connectivity
        run: |
          HOST="${{ secrets.EC2_HOST }}"
          PORT="22"
          echo "Checking if $HOST:$PORT is reachable..."
          if command -v nc >/dev/null 2>&1; then
            nc -zv -w 5 "$HOST" "$PORT"
          else
            timeout 5 bash -c "cat < /dev/null > /dev/tcp/$HOST/$PORT"
          fi
          echo "OK: $HOST:$PORT is reachable"

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 60m
          script: |
            # Navigate to app directory
            cd /home/ubuntu/eshop

            # Configure git to use personal access token
            git config --global url."https://${{ secrets.GH_ACCESS_TOKEN }}@github.com/".insteadOf "https://github.com/"

            # Discard local changes to tracked files before pulling
            git reset --hard HEAD
            # Optionally, clean untracked files except .env
            git clean -fd -e .env

            # Pull latest code
            BRANCH="${{ github.ref_name }}"
            git fetch origin "$BRANCH"
            git checkout -B "$BRANCH" "origin/$BRANCH"
            git reset --hard "origin/$BRANCH"

            # Set environment variables for deployment script
            export DOCKER_USERNAME="${{ secrets.DOCKERHUB_USERNAME }}"

            # Pass only changed services to deployment script
            export CHANGED_BACKEND='${{ needs.detect-changes.outputs.changed-backend }}'
            export CHANGED_FRONTEND='${{ needs.detect-changes.outputs.changed-frontend }}'

            # If no changes, deploy all (for initial deployment)
            if [ "$CHANGED_BACKEND" == "[]" ] && [ "$CHANGED_FRONTEND" == "[]" ]; then
              export CHANGED_BACKEND='["auth-service","product-service","order-service","seller-service","admin-service","chatting-service","kafka-service","logger-service","recommendation-service","api-gateway"]'
              export CHANGED_FRONTEND='["user-ui","seller-ui","admin-ui"]'
            fi

            # Make script executable and run deployment
            chmod +x scripts/deploy-production.sh
            ./scripts/deploy-production.sh

            # ---- Post-deploy health check (fail CI if site is not actually up) ----
            # Prefer repo script if you added it; otherwise run minimal inline checks.
            if [ -f scripts/eshop-postdeploy-check.sh ]; then
              chmod +x scripts/eshop-postdeploy-check.sh
              bash scripts/eshop-postdeploy-check.sh nomadnet.shop
            else
              echo "== Disk ==" && df -h /
              USED=$(df -P / | awk 'NR==2{gsub("%","",$5); print $5}')
              if [ "$USED" -ge 85 ]; then
                echo "ERROR: Disk usage is ${USED}% (>=85%)"
                exit 1
              fi

              echo "== Docker service =="
              systemctl is-active --quiet docker || (echo "ERROR: docker is not active" && exit 1)

              echo "== Containers =="
              docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

              echo "== HTTP/HTTPS =="
              curl -fsS "http://localhost/" -o /dev/null
              curl -fsSk "https://localhost/" -o /dev/null
              curl -fsSk "https://nomadnet.shop/" -o /dev/null || true
              echo "OK: post-deploy checks passed"
            fi

  # Deployment summary
  notify-completion:
    needs: [detect-changes, build-backend, build-frontend, deploy-to-ec2]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Build & Deploy Summary
        run: |
          echo "üéâ Build and deployment completed!"
          echo "Changed backend services: ${{ needs.detect-changes.outputs.changed-backend }}"
          echo "Changed frontend services: ${{ needs.detect-changes.outputs.changed-frontend }}"
          echo "Backend build status: ${{ needs.build-backend.result }}"
          echo "Frontend build status: ${{ needs.build-frontend.result }}"
          echo "Deployment status: ${{ needs.deploy-to-ec2.result }}"

          if [ "${{ needs.deploy-to-ec2.result }}" == "success" ] || [ "${{ needs.deploy-to-ec2.result }}" == "skipped" ]; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ùå Deployment failed"
          fi
